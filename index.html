<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ゆれるhalka</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #ffffff; }
        #header {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            background: hsl(353, 85%, 49%);
            color: #fff;
            padding: 14px 24px;
        }
        #date-string, #current-time { font-size: 2em; }
        #current-shindo {
            font-size: 10em;
            font-weight: bold;
            padding: 10px;
            border-radius: 16px;
            min-width: 220px;
            text-align: center;
            margin: 24px auto;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.10);
        }
        #controls { margin: 18px 24px; text-align: center; }
        #wsUrl { font-size: 1em; padding: 6px 8px; border-radius: 5px; border: 1px solid #ddd; width: 280px; }
        #connectBtn {
            font-size: 1em; padding: 6px 18px; border-radius: 5px;
            border: none; background: #23c32b; color: #fff; font-weight: bold; cursor: pointer;
        }
        .graph-container {
            height: 40vh; margin: 32px 24px 0; background: #fff; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(100,116,139,0.07); position: relative; padding: 1em;
        }
        canvas { width: 100%; height: 100%; }
        h2 { font-size: 1.5em; margin: 24px 24px; padding-bottom: 10px; border-bottom: 2px solid hsl(353, 85%, 49%); }
        footer {
            text-align: center; margin-top: 40px; padding: 20px; background: #f0f0f0;
            color: #333; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ゆれるhalka</h1>
        <p>Goryokaku Park, Hakodate City, Hokkaido, JAPAN</p>
        <span id="date-string"></span>
        <span id="current-time"></span>
        <p>加速度は100Hz, 震度は1Hzで出力。</p>
    </div>
    <div id="controls">
        <input id="wsUrl" type="text" value="wss://gal.halka.jp" placeholder="WebSocket URL">
        <button id="connectBtn" onclick="connectWebSocket()">Connect</button>
    </div>
    <span id="current-shindo">--</span>
    <h2>加速度</h2>
    <div id="accel-values" style="text-align:center; margin-bottom:10px;"></div>
    <div class="graph-container">
        <canvas id="xAccelChart"></canvas>
        <canvas id="yAccelChart"></canvas>
        <canvas id="zAccelChart"></canvas>
    </div>
    <h2>震度</h2>
    <div class="graph-container">
        <canvas id="shindoChart"></canvas>
    </div>
    <footer>
        <p>© 2025 halka. Powered by <a href="https://quake.one/sense/">QUAKE.ONE</a> Developed by Prioris.</p>
    </footer>
    <script>
        // Constants
        const jmaColors = {
            7: { bg: '#7d007d', text: 'white' },
            6.5: { bg: '#d70035', text: 'white' },
            6: { bg: '#ff0000', text: 'white' },
            5.5: { bg: '#ff6600', text: 'black' },
            5: { bg: '#ffff00', text: 'black' },
            4: { bg: '#fef4c0', text: 'black' },
            3: { bg: '#0068b7', text: 'white' },
            2: { bg: '#00a3e0', text: 'black' },
            1: { bg: '#ffffff', text: 'black' },
            0: { bg: '#f0f0f0', text: 'black' }
        };
        const maxAccelPoints = 100;
        const maxShindoPoints = 100;

        // Variables
        let ws = null;
        let xChart, yChart, zChart, shindoChart;

        // Initialize Date and Time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('date-string').textContent = now.toLocaleDateString('ja-JP');
            document.getElementById('current-time').textContent = now.toLocaleTimeString('ja-JP', { hour12: false });
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // WebSocket Management
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.warn('WebSocket already connected.');
                return;
            }

            const wsUrl = document.getElementById('wsUrl').value;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => updateConnectStatus(true);
            ws.onclose = () => updateConnectStatus(false);
            ws.onerror = (e) => console.error('WebSocket Error:', e);
            ws.onmessage = handleMessage;
        }

        function updateConnectStatus(isConnected) {
            const btn = document.getElementById('connectBtn');
            btn.textContent = isConnected ? 'Disconnect' : 'Connect';
            btn.style.background = isConnected ? '#ff0000' : '#23c32b';
            btn.onclick = isConnected ? () => ws.close() : connectWebSocket;
        }

        // Handle WebSocket Messages
        function handleMessage(event) {
            const parts = event.data.split(',');
            if (parts[0] === '$XSACC' && parts.length >= 4) {
                const [x, y, z] = parts.slice(1, 4).map(Number);
                updateAccelCharts(x, y, z);
                document.getElementById('accel-values').textContent = `X: ${x.toFixed(3)} Y: ${y.toFixed(3)} Z: ${z.toFixed(3)}`;
            }

            if (parts[0] === '$XSINT' && parts.length >= 3) {
                const shindo = parseFloat(parts[2]);
                updateCurrentShindo(shindo);
                updateShindoChart(shindo);
            }
        }

        // Update Current Shindo
        function updateCurrentShindo(shindo) {
            const colorKey = Object.keys(jmaColors).map(Number).reverse().find(k => shindo >= k);
            const color = jmaColors[colorKey] || jmaColors[0];
            const el = document.getElementById('current-shindo');
            el.textContent = shindo.toFixed(2);
            el.style.backgroundColor = color.bg;
            el.style.color = color.text;
        }

        // Create Charts
        function createChart(ctx, label, color) {
            return new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label, borderColor: color, data: [], tension: 0.2, pointRadius: 0 }] },
                options: { responsive: true, animation: false, scales: { x: { display: false }, y: { title: { display: true } } } }
            });
        }

        // Update Acceleration Charts
        function updateAccelCharts(x, y, z) {
            if (!xChart) xChart = createChart(document.getElementById('xAccelChart').getContext('2d'), 'X軸', '#FF0000');
            if (!yChart) yChart = createChart(document.getElementById('yAccelChart').getContext('2d'), 'Y軸', '#0000FF');
            if (!zChart) zChart = createChart(document.getElementById('zAccelChart').getContext('2d'), 'Z軸', '#00FF00');

            [xChart, yChart, zChart].forEach((chart, i) => {
                const value = [x, y, z][i];
                chart.data.labels.push('');
                chart.data.datasets[0].data.push(value);
                if (chart.data.labels.length > maxAccelPoints) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                chart.update();
            });
        }

        // Update Shindo Chart
        function updateShindoChart(shindo) {
            if (!shindoChart) {
                shindoChart = new Chart(document.getElementById('shindoChart').getContext('2d'), {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: '震度', data: [], backgroundColor: [] }] },
                    options: { responsive: true, scales: { y: { min: 0, max: 7 } } }
                });
            }

            const colorKey = Object.keys(jmaColors).map(Number).reverse().find(k => shindo >= k);
            shindoChart.data.labels.push('');
            shindoChart.data.datasets[0].data.push(shindo);
            shindoChart.data.datasets[0].backgroundColor.push(jmaColors[colorKey].bg);
            if (shindoChart.data.labels.length > maxShindoPoints) {
                shindoChart.data.labels.shift();
                shindoChart.data.datasets[0].data.shift();
                shindoChart.data.datasets[0].backgroundColor.shift();
            }
            shindoChart.update();
        }
    </script>
</body>
</html>